<%
local ver = require "luci.version"
local sys  = require "luci.sys"
local util = require "luci.util"
local http = require "luci.http"
local disp = require "luci.dispatcher"

local ubus = require "ubus"
local conn = ubus.connect()
local boardinfo = conn:call("system", "board") or {}
boardinfo.hostname = sys.hostname()
conn:close()

local request = disp.context.request or {}
local category = request[1]
local cattree = category and disp.node(category)
local tree = disp.node()
local categories = disp.node_childs(tree) or {}

-- Prepare content type
http.prepare_content("text/html")

-- URL helper function
local function nodeurl(prefix, name, query)
    local url = (prefix or "") .. name .. "/"
    if query then
        url = url .. http.build_querystring(query)
    end
    return pcdata(url)
end

-- Subtree rendering helper
local function render_subtree(prefix, node, level)
    level = level or 1
    local childs = disp.node_childs(node) or {}

    if level > 2 then
%>
<ul class="tabs">
<%
    end

    for _, name in ipairs(childs) do
        local child_node = node.nodes[name]
        if child_node then
%>
<li class="tabmenu-item-<%=name%><%- if child_node._menu_selected then %> active<% end %>">
    <a href="<%=nodeurl(prefix, name, child_node.query)%>"><%=striptags(translate(child_node.title))%></a>
</li>
<%
            if child_node._menu_selected then
                render_subtree(prefix .. name .. "/", child_node, level + 1)
            end
        end
    end

    if level > 2 then
%>
</ul>
<%
    end
end
%>
<!DOCTYPE html>
<html lang="<%=luci.i18n.context.lang%>">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%=striptags((boardinfo.hostname or "?") .. (node and " - " .. translate(node.title) or ""))%> - LuCI</title>
    <link rel="stylesheet" href="<%=media%>/css/style.css?v=<%=ver.luciversion%>">
    <link rel="icon" href="<%=media%>/images/icon.png" sizes="192x192">
    <script src="<%=resource%>/xhr.js?<%=ver.luciversion%>"></script>
</head>
<body>
<header>
    <div class="navbar">
        <a href="/cgi-bin/luci/admin/status/overview"><img src="<%=media%>/images/home.png" /></a>
        <a href="/cgi-bin/luci/admin/services/shadowsocksr"><img src="<%=media%>/images/ssr.png" /></a>
        <a href="/cgi-bin/luci/admin/network/network"><img src="<%=media%>/images/link.png" /></a>
        <a href="/cgi-bin/luci/admin/status/realtime"><img src="<%=media%>/images/rank.png" /></a>
        <a href="/cgi-bin/luci/admin/system/admin"><img src="<%=media%>/images/user.png" /></a>
    </div>
</header>
<div class="main">
    <div class="main-left">
        <ul class="nav">
<%
if cattree then
    render_subtree("/" .. category .. "/", cattree)
end
%>
        </ul>
    </div>
    <div class="main-right">
        <div id="maincontent">
            <% if category then render_subtree("/" .. category .. "/", cattree) end %>
        </div>
    </div>
</div>
</body>
</html>
